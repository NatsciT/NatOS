#pragma once

#include "../common.h"

#define MAX_GDT	5

// flags
#define I86_GDT_DESC_ACCESS		0b00000001
#define I86_GDT_DESC_READWRITE	0b00000010
#define I86_GDT_DESC_EXPANSION	0b00000100
#define I86_GDT_DESC_CODE_SEG	0b00001000

#define I86_GDT_DESC_CODEDATA	0b00010000
#define I86_GDT_DESC_DPL		0b01100000
#define I86_GDT_DESC_MEMORY		0b10000000

// gran
#define I86_GDT_GRAN_LIMITHI_MASK	0b00001111
#define I86_GDT_GRAN_OS				0b00010000
#define I86_GDT_GRAN_32BIT			0b01000000
#define I86_GDT_GRAN_4K				0b10000000



#define KERNEL_CODE_DESC_FLAGS	I86_GDT_DESC_READWRITE | I86_GDT_DESC_CODE_SEG | I86_GDT_DESC_CODEDATA | I86_GDT_DESC_MEMORY
#define KERNEL_CODE_DESC_GRAN	I86_GDT_GRAN_LIMITHI_MASK | I86_GDT_GRAN_32BIT | I86_GDT_GRAN_4K

#define KERNEL_DATA_DESC_FLAGS	I86_GDT_DESC_READWRITE | I86_GDT_DESC_CODEDATA | I86_GDT_DESC_MEMORY
#define KERNEL_DATA_DESC_GRAN	I86_GDT_GRAN_LIMITHI_MASK | I86_GDT_GRAN_32BIT | I86_GDT_GRAN_4K

#define USER_CODE_DESC_FLAGS	I86_GDT_DESC_READWRITE | I86_GDT_DESC_CODE_SEG | I86_GDT_DESC_CODEDATA | I86_GDT_DESC_DPL | I86_GDT_DESC_MEMORY
#define USER_CODE_DESC_GRAN		I86_GDT_GRAN_LIMITHI_MASK | I86_GDT_GRAN_32BIT | I86_GDT_GRAN_4K

#define USER_DATA_DESC_FLAGS	I86_GDT_DESC_READWRITE | I86_GDT_DESC_CODEDATA | I86_GDT_DESC_DPL | I86_GDT_DESC_MEMORY
#define USER_DATA_DESC_GRAN		I86_GDT_GRAN_LIMITHI_MASK | I86_GDT_GRAN_32BIT | I86_GDT_GRAN_4K



#pragma pack(push, 1)

typedef struct __gdt_desc
{
	uint16 segment_limit;
	uint16 base_low;
	uint8 base_mid;
	uint8 flags;
	uint8 gran;
	uint8 base_high;
} gdt_desc;

typedef struct __gdtr
{
	uint16 limit;
	uint32 base;
} gdtr;

#pragma pack(pop)



void gdt_init(void);